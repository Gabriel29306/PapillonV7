name: Weekly Expo Build for Android

on:
  schedule:
    - cron: "0 12 * * 1" # Tous les lundis à 12h UTC
  workflow_dispatch: # Permet d'exécuter manuellement le workflow

jobs:
  build-android:
    runs-on: ubuntu-latest

    steps:
    # 1. Récupérer le code depuis le repo cible
    - name: Checkout Action Repository
      uses: actions/checkout@v3
    
    # 2. Configurer Java 17
    - name: Set up Java 17
      uses: actions/setup-java@v3
      with:
        distribution: 'temurin' # Distribution Temurin (privilégiée)
        java-version: '17'
      
    # 3. Télécharger le repo Papillon
    - name: Checkout Target Repository
      run: |
        git clone https://github.com/PapillonApp/Papillon.git target-repo
        cd target-repo
        git checkout main

    # 4. Installer les dépendances et builder
    - name: Install Dependencies
      run: |
        cd target-repo
        npm install

    # 5. Prebuil l'app avec Expo
    - name: Prepare Android Build
      run: |
        cd target-repo
        npx expo prebuild -p android
  
    # 6. Configurer gradle.properties pour générer des APKs par architecture
    - name: Configure Gradle for Split APKs
      run: |
        echo "enableSeparateBuildPerCPUArchitecture=true" >> target-repo/android/gradle.properties

    # 7. Obtension de la dernière version postée, ou 7.7.0
    - name: Get Latest Release
      id: get_latest_release
      uses: actions/github-script@v6
      with:
        script: |
          try {
            const latestRelease = await github.rest.repos.getLatestRelease({
              owner: context.repo.owner,
              repo: context.repo.repo
            });
            core.setOutput("version", latestRelease.data.tag_name.replace("v", ""));
          } catch (error) {
            console.log("No release found, using default version.");
            core.setOutput("version", "7.7.0");
          }
    
    # 8. Incrémentation de la version
    - name: Increment Version Based on Release
      run: |
        cd target-repo
        # Rechercher la ligne contenant "versionCode"
        CURRENT_VERSION=$(grep -oP '(?<=versionCode )\d+' android/app/build.gradle || echo "1")
        # Calculer la nouvelle version
        NEW_VERSION=$((CURRENT_VERSION + 1))
        # Remplacer l'ancienne version par la nouvelle dans build.gradle
        sed -i "s/versionCode [0-9]*/versionCode ${NEW_VERSION}/" android/app/build.gradle
        # Vérification de la modification
        grep "versionCode" android/app/build.gradle
        echo "VERSION_CODE=${NEW_VERSION}" >> $GITHUB_ENV
  
    # 9. Build des apks
    - name: Build Release APK
      run: |
        cd target-repo/android
        # Étape 3 : Build release avec Gradle
        ./gradlew :app:assembleRelease
        tree target-repo/android/app/build/

    # 10. Publier les APKs dans une préversion
    - name: Create Pre-Release with APKs
      uses: ncipollo/release-action@v1
      with:
        tag: "v${{ env.VERSION_CODE }}"
        name: "Weekly Build v${{ env.VERSION_CODE }}"
        body: "Build automatique hebdomadaire pour Android."
        prerelease: true
        artifacts: |
          target-repo/android/app/build/outputs/apk/release/*-arm64-v8a-release.apk
          target-repo/android/app/build/outputs/apk/release/*-armeabi-v7a-release.apk
          target-repo/android/app/build/outputs/apk/release/*-x86-release.apk
          target-repo/android/app/build/outputs/apk/release/*-x86_64-release.apk
