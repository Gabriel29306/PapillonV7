name: Weekly Expo Build for Android

on:
  schedule:
    - cron: "0 0 * * 1" # Tous les lundis √† 00h00 UTC
  workflow_dispatch:
    inputs:
      patch_selection:
        description: "Patchs √† appliquer (s√©parer par des virgules, ou 'all' pour tous)"
        required: false
        default: "all"

jobs:
  build-android:
    runs-on: ubuntu-latest

    steps:
    # 1. R√©cup√©rer le fichier JSON des sources et patchs
    - name: üì• Fetch Patch List
      id: fetch_patch_list
      run: |
        curl -sL -H "Cache-Control: no-cache, no-store" https://raw.githubusercontent.com/Gabriel29306/datasets/main/papillon_7_patchs.json -o patch_list.json
        echo $(cat patch_list.json)

    # 2. Extraire les informations des sources et patchs
    - name: üóÇ Parse Sources and Patch List
      id: parse_patch_list
      run: |
        echo "Parsing sources and patch list..."
        MAIN_REPO="https://github.com/PapillonApp/Papillon.git"
        ALL_PATCHES=$(jq -r '.patchs | join(",")' patch_list.json)
        echo "MAIN_REPO=$MAIN_REPO" >> $GITHUB_ENV
        echo "ALL_PATCHES=$ALL_PATCHES" >> $GITHUB_ENV

        # Extraire les sources sous forme de paires "nom=url"
        jq -r '.source | to_entries[] | "\(.key)=\(.value)"' patch_list.json > sources.txt

    # 3. V√©rifier et choisir les patchs √† appliquer
    - name: üîç Select Patches
      id: select_patches
      run: |
        PATCH_INPUT="${{ inputs.patch_selection }}"
        if [[ "$PATCH_INPUT" == "all" ]]; then
          SELECTED_PATCHES=$ALL_PATCHES
        else
          SELECTED_PATCHES=$PATCH_INPUT
        fi
        echo "Selected patches: $SELECTED_PATCHES"
        echo "SELECTED_PATCHES=$SELECTED_PATCHES" >> $GITHUB_ENV

    # 4. Cloner le main repo
    - name: üîß Clone Main Repository
      run: |
        git clone $MAIN_REPO target-repo
        cd target-repo
        git checkout main

    # Ajout de la configuration Git
    - name: üîß Configure Git User
      run: |
        git config --global user.email "github-actions@github.com"
        git config --global user.name "GitHub Actions"

    # Ajouter les upstreams
    - name: üîó Add Upstreams from Sources
      run: |
        SOURCES=$(curl -s https://raw.githubusercontent.com/Gabriel29306/datasets/main/papillon_7_patchs.json | jq -r '.source | to_entries[] | @base64')
        for source in $SOURCES; do
          ENTRY=$(echo "$source" | base64 --decode)
          NAME=$(echo "$ENTRY" | jq -r '.key')
          URL=$(echo "$ENTRY" | jq -r '.value')
          git remote add "$NAME" "$URL"
        done

    # Appliquer les patchs
    - name: ‚öôÔ∏è Apply Selected Patches
      run: |
        PATCHES="Gabriel29306/better-logs, Gabriel29306/repair-pronote"
        for PATCH in $(echo $PATCHES | tr "," "\n"); do
          NAME=$(echo "$PATCH" | cut -d/ -f1)
          BRANCH=$(echo "$PATCH" | cut -d/ -f2)
          echo "Merging patch: $PATCH"
          git fetch "$NAME" "$BRANCH"
          git merge "$NAME/$BRANCH" --no-commit || {
            echo "Conflit d√©tect√© avec le patch $PATCH. Ignor√©."
            git merge --abort
          }
        done

    # 6. Installer les d√©pendances
    - name: üì• Install Dependencies
      run: |
        cd target-repo
        npm install

    # 7. Prebuild l'app avec Expo
    - name: ‚öôÔ∏è Prepare Android Build
      run: |
        cd target-repo
        npx expo prebuild -p android

    # 8. Build les APKs
    - name: üèóÔ∏è Build Release APK
      if: ${{ false }}
      run: |
        cd target-repo/android
        ./gradlew :app:assembleRelease

    # 9. Publier les APKs
    - name: üì§ Publish APKs
      if: ${{ false }}
      uses: ncipollo/release-action@v1
      with:
        tag: "weekly-build"
        name: "Weekly Build"
        body: "Build automatique hebdomadaire pour Android."
        prerelease: true
        artifacts: |
          target-repo/android/app/build/outputs/apk/release/*.apk
