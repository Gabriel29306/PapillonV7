name: Weekly Expo Build for Android

on:
  schedule:
    - cron: "0 12 * * 1" # Tous les lundis à 12h UTC
  workflow_dispatch: # Permet d'exécuter manuellement le workflow

jobs:
  build-android:
    runs-on: ubuntu-latest

    steps:
    # 1. Récupérer le code depuis le repo cible
    - name: Checkout Action Repository
      uses: actions/checkout@v3
      
    - name: Checkout Target Repository
      run: |
        git clone https://github.com/PapillonApp/Papillon.git target-repo
        cd target-repo
        git checkout main

    # 2. Configurer gradle.properties pour générer des APKs par architecture
    - name: Configure Gradle for Split APKs
      run: |
        echo "enableSeparateBuildPerCPUArchitecture=true" >> target-repo/android/gradle.properties

    # 3. Auto-incrémentation de la version (build number)
    - name: Increment Version
      run: |
        cd target-repo
        VERSION_CODE=$(grep "versionCode" android/app/build.gradle | awk '{print $2}')
        NEW_VERSION_CODE=$((VERSION_CODE + 1))
        sed -i "s/versionCode $VERSION_CODE/versionCode $NEW_VERSION_CODE/" android/app/build.gradle
        git config --global user.name "GitHub Actions"
        git config --global user.email "actions@github.com"
        git commit -am "Auto-increment version to $NEW_VERSION_CODE"
        git push

    # 4. Installer les dépendances et builder
    - name: Install Dependencies
      run: |
        cd target-repo
        npm install

    - name: Build APKs
      run: |
        cd target-repo
        npm run build:android # Assure-toi que cette commande existe dans ton projet

    # 5. Publier les APKs dans une préversion
    - name: Create Pre-Release with APKs
      uses: ncipollo/release-action@v1
      with:
        tag: "v$(date +'%Y%m%d')"
        name: "Weekly Build $(date +'%Y-%m-%d')"
        body: "Build automatique hebdomadaire pour Android."
        prerelease: true
        files: |
          target-repo/android/app/build/outputs/apk/release/*-arm64-v8a-release.apk
          target-repo/android/app/build/outputs/apk/release/*-armeabi-v7a-release.apk
          target-repo/android/app/build/outputs/apk/release/*-x86-release.apk
          target-repo/android/app/build/outputs/apk/release/*-x86_64-release.apk
